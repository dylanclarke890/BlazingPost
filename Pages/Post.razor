@page "/post"
@using BlazingPostMan.Shared.Tab; 
@inject IRequestProcessor requestProcessor

<!--
TODO:
    1. Ability to add content to PUT or POST requests (body of request).
    2. Update error UI (low priority).
-->

<h3>Post</h3>

<div class="form-group">
    <label for="url-input">Enter a URL: </label>
    <input class="form-control" id="url-input" type="text" @bind="Url" />
</div>

<TabSet>
    <TabChild Title="Params">
        <UrlParameters Params="Params" OnParamAction="() => { StateHasChanged(); }"/>
    </TabChild>
    <TabChild Title="Body">
        <p>Body</p>
    </TabChild>
</TabSet>


<select @bind="requestType">
    <option value="@RequestType.POST">@RequestType.POST</option>
    <option value="@RequestType.GET">@RequestType.GET</option>
    <option value="@RequestType.PUT">@RequestType.PUT</option>
    <option value="@RequestType.DELETE">@RequestType.DELETE</option>
</select>

<div class="mt-3">
    <h4>Preview: </h4>
    <p>@requestType: @GetUrl()</p>
</div>

<h4>Test</h4>
<button class="btn btn-primary" @onclick="SendRequest" disabled="@Sending">Send</button>

<p>Result:</p>
<div>
    @requestResult
</div>

@code {
    private string Url { get; set; } = "https://localhost:44384/api/testendpoint";

    private bool Sending = false;

    private string requestResult;
    private RequestType requestType { get; set; }

    private Dictionary<string, string> Params = new() { ["test key"] = "this is a test val" };

    private string GetUrl()
    {
        // TODO: Refactor (string builder).

        string url = "";
        url += Url;
        if (Params.Any())
        {
            url += "?";
            foreach (var keyValue in Params)
            {
                url += $"{keyValue.Key}={keyValue.Value}&";
            }

            // Remove extra '&'
            url = url.Substring(0, url.Length - 1);
        }
        return url;
    }

    private async Task SendRequest()
    {
        Sending = true;
        var result = await requestProcessor.ProcessRequest(GetUrl(), requestType);
        requestResult = await result.Content.ReadAsStringAsync();
        Sending = false;
    }
}

<style>
    .hand {
        cursor: pointer;
    }
</style>